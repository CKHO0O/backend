kind: pipeline
type: docker
name: default

steps:
  - name: build
    image: node:14-alpine
    commands:
      - yarn install
      - yarn build
  - name: publish
    image: plugins/docker
    settings:
      username: _json_key
      password:
        from_secret: gcr_key
      registry: gcr.io
      repo: gcr.io/pxlblue/backend
      tags: ["${DRONE_COMMIT}", "latest"]
  - name: deploy
    image: sinlead/drone-kubectl
    settings:
      kubernetes_server:
        from_secret: k8s_server
      kubernetes_cert:
        from_secret: k8s_cert
      kubernetes_token:
        from_secret: k8s_token
    commands:
      - kubectl config set-context production
      - kubectl config use-context production
      - kubectl apply -f kubernetes/deployment.yaml
